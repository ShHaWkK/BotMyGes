#!/usr/bin/env node
"use strict";var e=require("readline"),t=require("commander"),o=require("inquirer"),r=require("colors"),a=require("moment"),s=require("update-notifier"),n=require("fs"),i=require("path"),u=require("os"),c=require("axios");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=l(e),p=l(t),m=l(o),f=l(r),g=l(a),y=l(s),_=l(n),h=l(i),w=l(u),b=l(c),j="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},$={},v={name:"myges",version:"1.14.0",description:"",keywords:[],main:"dist/bundle.js",scripts:{start:"node .",dev:"nodemon .",build:"tsc",bundle:"rollup -c",lint:"eslint src/**/*.ts --fix",prepare:"npm run build && npm run bundle"},files:["dist/bundle.js"],bin:{myges:"dist/bundle.js"},contributors:[{name:"Nathanael Demacon",email:"nathanael.dmc@outlook.fr"}],repository:{type:"git",url:"git://github.com/quantumsheep/myges-cli.git"},author:"Nathanael Demacon <nathanael.dmc@outlook.fr>",license:"MIT",dependencies:{axios:"^0.21.1",colors:"^1.4.0",commander:"^4.1.1",inquirer:"^7.3.0",moment:"^2.29.1","update-notifier":"^4.1.0"},devDependencies:{"@rollup/plugin-commonjs":"^19.0.0","@rollup/plugin-json":"^4.1.0","@types/inquirer":"^7.3.1","@types/update-notifier":"^5.0.0","@typescript-eslint/eslint-plugin":"^4.15.2","@typescript-eslint/parser":"^4.15.2",eslint:"^7.20.0","eslint-config-airbnb-base":"^14.2.1","eslint-config-prettier":"^8.0.0","eslint-plugin-import":"^2.22.1",rollup:"^2.48.0","rollup-plugin-terser":"^7.0.2",typescript:"^4.1.5"}},S={},O={},D=j&&j.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(O,"__esModule",{value:!0}),O.authenticate=void 0;const q=D(b.default);O.authenticate=async function(e,t){var o,r,a;try{const o=Buffer.from(`${e}:${t}`,"utf8").toString("base64");await q.default({method:"GET",url:"https://authentication.reseau-ges.fr/oauth/authorize?response_type=token&client_id=skolae-app",headers:{Authorization:`Basic ${o}`},maxRedirects:0});return null}catch(e){if(!(null===(a=null===(r=null===(o=e.request)||void 0===o?void 0:o.res)||void 0===r?void 0:r.headers)||void 0===a?void 0:a.location))throw new Error("Bad password");const{location:t}=e.request.res.headers,s=t.slice(t.indexOf("#")+1).split("&").map((e=>e.split("="))).reduce(((e,[t,o])=>Object.assign(Object.assign({},e),{[t]:o})),{});return{access_token:s.access_token,token_type:s.token_type,expires_in:s.expires_in,scope:s.scope,uid:s.uid}}};var k=j&&j.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),M=j&&j.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Y=j&&j.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&k(t,e,o);return M(t,e),t},T=j&&j.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(S,"__esModule",{value:!0}),S.erase=S.load=S.save=S.prompt_credentials=void 0;const N=_.default,E=T(h.default),x=T(m.default),G=w.default,P=Y(O),C=E.default.resolve(G.homedir(),".myges");async function I(e){return await N.promises.writeFile(C,JSON.stringify(e))}function A(){return console.error("You must be logged in before using that command. (myges login)"),process.exit(1)}S.prompt_credentials=async function(){try{const{username:e,password:t}=await x.default.prompt([{message:"Username: ",name:"username"},{message:"Password: ",name:"password",type:"password"}]);return Object.assign({username:e},await P.authenticate(e,t))}catch(e){throw e.isTtyError?new Error(`Prompt couldn't be rendered in the current environment: ${e.message}`):e}},S.save=I,S.load=async function(e=!1){var t,o;try{const r=await N.promises.readFile(C,{encoding:"utf8"}),a=JSON.parse(r);if(e&&(!a.username||!a.access_token||!a.token_type||!a.expires))return A();if(a.expires&&Date.now()>=a.expires){const{password:e}=await x.default.prompt([{message:"Session expired - Enter your password: ",name:"password",type:"password"}]),t=await P.authenticate(a.username,e);a.access_token=t.access_token,a.token_type=t.token_type,a.expires=Date.now()+1e3*parseInt(t.expires_in,10),await I(a)}return{access_token:null!==(t=a.access_token)&&void 0!==t?t:null,token_type:null!==(o=a.token_type)&&void 0!==o?o:null}}catch(t){return e?A():{access_token:null,token_type:null}}},S.erase=async function(){return await N.promises.writeFile(C,JSON.stringify({}))};var J={},L=j&&j.__rest||function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(o[r[a]]=e[r[a]])}return o},H=j&&j.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(J,"__esModule",{value:!0}),J.get_years=J.request=void 0;const F=H(b.default);async function V(e,t,o,r={}){const{headers:a}=r,s=L(r,["headers"]),{data:n}=await F.default.request(Object.assign({url:`https://services.reseau-ges.fr${t}`,method:e,headers:Object.assign(Object.assign({},a),{Authorization:`${o.token_type} ${o.access_token}`})},s));return n.result}J.request=V,J.get_years=async function(e){return await V("GET","/me/years",e)};var B={},R=j&&j.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(B,"__esModule",{value:!0}),B.multiple=B.table=void 0;const W=R(f.default);function z(e,t,o=!0){if(o){for(const e in t){const o=t[e]-e.length;process.stdout.write(W.default.cyan(e)),process.stdout.write("".padStart(o," ")),process.stdout.write("   ")}process.stdout.write("\n")}for(const o of e){for(const e in t){const r=t[e],a=`${o[e]||""}`,s=r-a.length;process.stdout.write(`${a}`),process.stdout.write("".padStart(s," ")),process.stdout.write("   ")}process.stdout.write("\n")}process.stdout.write("\n")}function U(...e){const t=[];return e.forEach((e=>{e.forEach(((o,r)=>{if(-1===t.indexOf(o))if(r>0){const a=t.indexOf(e[r-1]);t.splice(a+1,0,o)}else t.push(o)}))})),t}function K(e){return U(...e.map(Object.keys))}function Q(e,t=K(e)){return t.reduce(((t,o)=>(t[o]=Math.max(o.length,...e.map((e=>o in e?`${e[o]}`.length:0))),t)),{})}B.table=function(e,t=!0){z(e,Q(e),t)},B.multiple=function(e,t=!0){const o=U(...e.map(K)),r=e.reduce(((e,t)=>{const r=Q(t,o);for(const t in r)e[t]=Math.max(e[t]||0,r[t]);return e}),{});for(const o of e)z(o,r,t)};var X=j&&j.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),Z=j&&j.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),ee=j&&j.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&X(t,e,o);return Z(t,e),t},te=j&&j.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty($,"__esModule",{value:!0});const oe=te(d.default),re=te(p.default),ae=te(m.default),se=te(f.default),ne=te(g.default),ie=te(y.default),ue=v,ce=ee(S),le=ee(J),de=ee(B);ie.default({pkg:ue,shouldNotifyInNpmScript:!0}).notify({isGlobal:!0});const pe=new re.default.Command;pe.version(ue.version),pe.command("login").option("-d, --debug","debug mode").description("sign in to an account").action((async e=>{try{const e=await ce.prompt_credentials();await ce.save({username:e.username,token_type:e.token_type,access_token:e.access_token,expires:Date.now()+1e3*parseInt(e.expires_in,10)}),console.log("Successfully logged in!")}catch(t){e.debug?console.error(t):console.error(t.message)}})),pe.command("logout").option("-d, --debug","debug mode").description("remove the saved auth informations").action((async e=>{try{await ce.erase(),console.log("Successfully logged out!")}catch(t){e.debug?console.error(t):console.error(t.message)}})),pe.command("absences [year]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").description("list absences").action((async(e,t)=>{try{const o=await ce.load(!0);if(!e){e=(await ae.default.prompt([{message:"Choose a year",name:"year",type:"list",choices:await le.get_years(o)}])).year}const r=await le.request("GET",`/me/${e}/absences`,o);t.raw?console.log(JSON.stringify(r)):r?de.table(r.map((e=>({Year:e.year,Date:ne.default(e.date).format("DD/MM/YYYY, HH:mm"),"Course name":e.course_name,Justified:e.justified,Trimester:e.trimester_name})))):console.log("Nothing to display.")}catch(e){t.debug?console.error(e):console.error(e.message)}})),pe.command("courses [year]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").description("list courses").action((async(e,t)=>{try{const o=await ce.load(!0);if(!e){e=(await ae.default.prompt([{message:"Choose a year",name:"year",type:"list",choices:await le.get_years(o)}])).year}const r=await le.request("GET",`/me/${e}/courses`,o);if(t.raw)console.log(JSON.stringify(r));else if(r){[...new Set(r.map((e=>e.trimester)))].sort().forEach((e=>{const t=r.filter((t=>t.trimester===e)).map((e=>({rc_id:e.rc_id,Year:e.year,Trimester:`${e.trimester} (${e.trimester_id})`,Name:e.name,"Student group":`${e.student_group_name} (${e.student_group_id})`,Teacher:`${e.teacher} (${e.teacher_id})`})));de.table(t)}))}else console.log("Nothing to display.")}catch(e){t.debug?console.error(e):console.error(e.message)}})),pe.command("grades [year]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").description("list grades").action((async(e,t)=>{try{const o=await ce.load(!0);if(!e){e=(await ae.default.prompt([{message:"Choose a year",name:"year",type:"list",choices:await le.get_years(o)}])).year}const r=await le.request("GET",`/me/${e}/grades`,o);if(t.raw)console.log(JSON.stringify(r));else if(r){const e=[...new Set(r.map((e=>e.trimester)))].sort().map((e=>{const t=r.filter((t=>t.trimester===e)),o=Math.max(...t.map((e=>e.grades.length))),a=t.map((e=>[...Array(o).keys()].reduce(((t,o)=>(t[`CC${o+1}`]=e.grades.length>o?e.grades[o]:null,t)),{}))),s=t.map(((e,t)=>{const o=null===e.average&&e.grades.length>0?e.grades.reduce(((e,t)=>e+t),0)/e.grades.length:e.average;return Object.assign(Object.assign({Year:e.year,Trimester:`${e.trimester_name} (${e.trimester})`,Teacher:`${e.teacher_civility} ${e.teacher_last_name} ${e.teacher_first_name}`,Course:e.course,"Coef. / ECTS":e.coef||e.ects},a[t]),{Exam:e.exam,Average:null!==o?Math.floor(100*o)/100:null})}));let n=0;const i=s.map((e=>{if(null!==e.Average){const t=parseFloat(e["Coef. / ECTS"])||1;return n+=t,e.Average*t}return null})).filter((e=>null!==e)),u=n>0&&i.reduce(((e,t)=>e+t),0)/n||0;return s.push({Course:"GLOBAL AVERAGE",Average:Math.floor(100*u)/100}),s}));de.multiple(e)}else console.log("Nothing to display.")}catch(e){t.debug?console.error(e):console.error(e.message)}})),pe.command("agenda [week]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").option("-i, --interactive","interactive mode").description("fetch agenda").action((async(e,t)=>{try{const o=await ce.load(!0),r=ne.default();if(!e){const o=r.clone().subtract(r.day(),"day").set("hours",23);if(t.interactive){const t=e=>{const t=e.clone().add(7,"days");return`${e.format("DD-MM-YYYY")} ${t.format("DD-MM-YYYY")}`},r=[...Array(9).keys()].map((e=>t(o.clone().add(7*(e+1),"days")))).reverse(),a=[...Array(9).keys()].map((e=>t(o.clone().subtract(7*(e+1),"days")))),s=t(o.clone());e=(await ae.default.prompt([{message:"Choose a week",name:"week",type:"list",choices:[...r,s,...a],default:s}])).week.split(" ")[0]}else e=o.format("DD-MM-YYYY")}let a=ne.default().set("hours",0),s=ne.default().set("hours",23),n=+(e.split("+")[1]||0);if(e.startsWith("today"))a=a.add(n,"days"),s.add(n,"days");else if(e.startsWith("tomorrow"))a.add(n+1,"days"),s.add(n+1,"days");else if(e.startsWith("yesterday"))a=a.subtract(n+1,"days"),s.subtract(n+1,"days");else{e.startsWith("week")&&(n*=7,e=r.format("DD-MM-YYYY"));const[t,o=r.month()+1,i=r.year()]=e.split(/[\-\+]/g).map((e=>parseInt(e,10))),u=ne.default().set("year",i).set("month",o-1).set("date",t+n).set("hours",23);a=u.clone().subtract(u.day(),"days"),s=a.clone().add(7,"days")}a.isSame(s)?console.log(`Loading agenda for ${a.format("DD-MM-YYYY")}...`):console.log(`Loading agenda from ${a.format("DD-MM-YYYY")} to ${s.format("DD-MM-YYYY")}...`);const i=await le.request("GET",`/me/agenda?start=${a.valueOf()}&end=${s.valueOf()}`,o);if(t.raw)console.log(JSON.stringify(i));else{0===i.length&&console.log("Nothing to display in this dates range.");const e=i.map((e=>ne.default(e.start_date))).sort(((e,t)=>e.diff(t))).map((e=>e.toDate().toDateString())),t=[...new Set(e)].map((e=>i.filter((t=>ne.default(t.start_date).toDate().toDateString()===e)).sort(((e,t)=>e.start_date-t.start_date)).map((e=>{var t;const o=ne.default(e.start_date),r=ne.default(e.end_date),a=ne.default("11:30","HH:mm").format("LT").length;let s="Distanciel"===e.modality?"Remote":"Unknown";if((null===(t=e.rooms)||void 0===t?void 0:t.length)>0){const t=e.rooms[0];s=e.rooms.map((e=>`${t.campus} ${t.name} (${t.floor})`)).join(" - ")}return{Day:o.format("ddd, LL"),Schedule:`${o.format("LT").padStart(a,"0")} -> ${r.format("LT").padStart(a,"0")}`,"Room(s)":s,Name:e.name,Teacher:e.teacher}}))));de.multiple(t)}}catch(e){t.debug?console.error(e):console.error(e.message)}})),pe.command("request <method> <url>").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").option("-t, --table","output data in a table").option("-b, --body <value>","add a body (must be a JSON)","{}").description("make a request to the API").action((async(e,t,o)=>{try{const r=await ce.load(!0),a=await le.request(e,t,r,{data:o.body,headers:{"Content-type":"application/json; charset=utf-8"}});o.raw?console.log(JSON.stringify(a)):o.table?de.table(a):console.log(a)}catch(e){o.debug?console.error(e):console.error(e.message)}})),pe.command("projects [year]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").description("list projects").action((async(e,t)=>{try{const o=await ce.load(!0);if(!e){e=(await ae.default.prompt([{message:"Choose a year",name:"year",type:"list",choices:await le.get_years(o)}])).year}const r=await le.request("GET",`/me/${e}/projects`,o);if(t.raw)console.log(JSON.stringify(r));else if(r){const{uid:e}=await le.request("GET","/me/profile",o);de.table(r.map((t=>{const o=t.groups.find((t=>!!(t.project_group_students||[]).find((t=>t.u_id===e)))),r={};if(o&&(5301==t.project_id&&(r.Test=5),r.Group=`${o.group_name} (${o.project_group_id})`,o.date_presentation>0)){const e=new Date(o.date_presentation);r["Presentation Date"]=`${e.toDateString()} at ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}return Object.assign({ID:t.project_id,Name:t.name},r)})))}else console.log("Nothing to display.")}catch(e){t.debug?console.error(e):console.error(e.message)}})),pe.command("project [id] [action] [value]").option("-d, --debug","debug mode").option("-r, --raw","output the raw data").option("-y, --year","pre-select a year").description("show a project's informations - possible actions: show, groups, join, quit").action((async(e,t,o,r)=>{try{const n=await ce.load(!0);let i=null;if(e)i=await le.request("GET",`/me/projects/${e}`,n);else{if(!r.year){const e=await ae.default.prompt([{message:"Choose a year",name:"year",type:"list",choices:await le.get_years(n)}]);r.year=e.year}const t=await le.request("GET",`/me/${r.year}/projects`,n),o=await ae.default.prompt([{message:"Choose a project",name:"project",type:"list",choices:t.map((e=>({name:e.name,value:e.project_id})))}]);e=o.project,i=t.find((t=>t.project_id===e))}if(!i)return console.error(`Project ${e} not found.`);const{uid:u}=await le.request("GET","/me/profile",n);if(t&&"show"!==t){if("join"===t){let e=i.groups.find((e=>!!(e.project_group_students||[]).find((e=>e.u_id===u))));if(e)return console.error(`You already are in a group for this project (${e.group_name}).`);if(!o){const e=await ae.default.prompt([{message:"Select the group to join",name:"group",type:"list",choices:i.groups.map((e=>{const t=(e.project_group_students||[]).map((e=>`${e.firstname} ${e.name}`));return{name:e.group_name+(t.length>0?`(${t.join(", ")})`:""),value:e.project_group_id}}))}]);o=e.group}if(o=parseInt(o),isNaN(o))return console.error("Incorrect group number.");const t=i.groups.sort(((e,t)=>e.project_group_id-t.project_group_id));if(e=o>t.length?t.find((e=>e.project_group_id==o)):t[o-1],!e)return console.error("Choosen group not found.");try{await le.request("POST",`/me/courses/${i.rc_id}/projects/${i.project_id}/groups/${e.project_group_id}`,n);console.log("Successfully joined the group!")}catch(e){r.debug?console.error(e):console.error("Failed to join the project's group.")}}else if("quit"===t){const e=i.groups.find((e=>!!(e.project_group_students||[]).find((e=>e.u_id===u))));if(!e)return console.error("You are not actually in a group.");const{confirm:t}=await ae.default.prompt([{message:`Do you really want to quit ${e.group_name}?`,name:"confirm",type:"confirm",default:!1}]);if(t)try{await le.request("DELETE",`/me/courses/${i.rc_id}/projects/${i.project_id}/groups/${e.project_group_id}`,n);console.log("Successfully quitted the group!")}catch(e){r.debug?console.error(e.response.data):console.error("Failed to quit the project's group.")}}else if("groups"===t)de.table(i.groups.map((e=>Object.assign({id:e.project_group_id,name:e.group_name},(e.project_group_students||[]).map((e=>`${e.firstname} ${e.name}`)).reduce(((e,t,o)=>(e[`Student ${o+1}`]=t,e)),{})))));else if("chat"===t){const e=i.groups.find((e=>!!(e.project_group_students||[]).find((e=>e.u_id===u)))),t=oe.default.createInterface({input:process.stdin,output:process.stdout});t.once("SIGINT",(()=>{process.exit(0)}));const o=await le.request("GET",`/me/projectGroups/${e.project_group_id}/messages`,n);function a(e){const t=new Date(e.date),o=`${t.getDate().toString().padStart(2,"0")}/${t.getMonth().toString().padStart(2,"0")}/${t.getFullYear()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;let r="";r=e.uid===u?se.default.grey(`[${o}] You`):se.default.cyan(`[${o}] ${e.firstname} ${e.name}`),console.log(`${r}${se.default.grey(":")} ${e.message}`)}o.forEach(a);let c=null;async function s(){c&&clearTimeout(c),process.stdout.clearLine(0),process.stdout.cursorTo(0);const r=(await le.request("GET",`/me/projectGroups/${e.project_group_id}/messages`,n)).slice(o.length);for(const e of r)a(e),o.push(e);c=setTimeout(s,2e4),t.prompt()}t.on("line",(async o=>{try{await le.request("POST",`/me/projectGroups/${e.project_group_id}/messages`,n,{data:{projectGroupId:e.project_group_id,message:o}});await s()}catch(e){r.debug?console.error(e):console.error(e.message),t.prompt()}})),await s()}}else if(r.raw)console.log(JSON.stringify(i));else{const e=i.groups.find((e=>!!(e.project_group_students||[]).find((e=>e.u_id===u))));let t={};if(e&&(t={Group:`${e.group_name} (${e.project_group_id})`},e.date_presentation>0)){const o=new Date(e.date_presentation);t["Presentation Date"]=`${o.toDateString()} at ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`}de.table([{Name:se.default.cyan("ID"),Value:i.project_id},{Name:se.default.cyan("Name"),Value:i.name},...Object.keys(t).map((e=>({Name:se.default.cyan(e),Value:t[e]})))],!1)}}catch(e){r.debug?console.error(e):console.error(e.message)}})),pe.command("contribute").description("show useful links").action((()=>{de.table([{Name:se.default.cyan("Réseau GES (GHG Network)"),Value:"http://www.reseau-ges.fr"},{Name:se.default.cyan("GitHub repository"),Value:"https://github.com/quantumsheep/myges-cli"},{Name:se.default.cyan("Issues"),Value:"https://github.com/quantumsheep/myges-cli/issues"}],!1)})),pe.action((async()=>pe.help())),process.argv.length<3?pe.help():pe.parse(process.argv),module.exports=$;
